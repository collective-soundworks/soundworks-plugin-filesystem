# soundworks | plugin filesystem

[![npm version](https://badge.fury.io/js/@soundworks%2Fplugin-filesystem.svg)](https://badge.fury.io/js/@soundworks%2Fplugin-filesystem)

[`soundworks`](https://soundworks.dev) plugin to watch directories and update their contents from any node.

## Table of Contents

<!-- toc -->

- [Installation](#installation)
- [Usage](#usage)
- [Notes](#notes)
- [API](#api)
- [ClientPluginFilesystem](#clientpluginfilesystem)
- [ServerPluginFilesystem](#serverpluginfilesystem)
- [Credits](#credits)
- [License](#license)

<!-- tocstop -->

## Installation

```sh
npm install @soundworks/plugin-filesystem --save
```

## Usage

### Server

```js
// index.js
import { Server } from '@soundworks/core/server.js';
import ServerPluginFilesystem from '@soundworks/plugin-filesystem/server.js';

const server = new Server();
server.pluginManager.register('filesystem', ServerPluginFilesystem, {
  // path to the watched directory, can be relative to process.cwd()
  // or absolute, in all cases file paths in the tree will be normalized
  // to be relative to `process.cwd()`
  dirname: 'path/to/directory',
  // if defined, add an `url` to each tree node, that defines the
  // route at which the files are publicly accessible.
  publicPath: '',
});

await server.start();

const filesystem = await server.pluginManager.get('filesystem');
await filesystem.writeFile('my-file.txt', 'Hello Server');
```

### Client

```js
// index.js
import { Client } from '@soundworks/core/client.js';
import ClientPluginFilesystem from '@soundworks/plugin-filesystem/client.js';

const client = new Client();
client.pluginManager.register('filesystem', ClientPluginFilesystem, {});

await client.start();

const filesystem = await client.pluginManager.get('filesystem');
await filesystem.writeFile('my-file.txt', 'Hello Client');
```

## Security Note

Being able to write and delete files from any connected client can create obvious security issues, moreover if your application aims at running online.

To prevent such issues, all sensible operations (i.e. other than listing the files) of the  plugin are blocked if the `env.type` config option passed to the Server is set to `production`. In this case, only authenticated and trusted clients will be able to perform these operations.

See the `config/env-**.js` files to configure your application (@todo - tutorial).

## API

<!-- api -->
<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [ClientPluginFilesystem][1]
    *   [getTree][2]
    *   [onUpdate][3]
    *   [getTreeAsUrlMap][4]
    *   [findInTree][5]
    *   [readFile][6]
    *   [writeFile][7]
    *   [mkdir][8]
    *   [rename][9]
    *   [rm][10]
*   [ServerPluginFilesystem][11]
    *   [Examples][12]
    *   [switch][13]
    *   [getTree][14]
    *   [onUpdate][15]
    *   [findInTree][16]
    *   [readFile][17]
    *   [writeFile][18]
    *   [mkdir][19]
    *   [rename][20]
    *   [rm][21]

## ClientPluginFilesystem

**Extends ClientPlugin**

Client-side representation of the soundworks' filesystem plugin.

The constructor should never be called manually. The plugin will be
instantiated when registered in the `pluginManager`

### getTree

Return the current filesystem tree.

Returns **[Object][22]**&#x20;

### onUpdate

Register a callback to execute when a file is created, modified or deleted
on the underlying directory. The callback will receive the updated `tree`
and the list of `events` describing the modifications made on the tree.

#### Parameters

*   `callback` **[Function][23]** Callback function to execute
*   `executeListener` **[boolean][24]** If true, execute the given
    callback immediately. (optional, default `false`)

Returns **[Function][23]** Function that unregister the listener when executed.

### getTreeAsUrlMap

Return the tree as flat map of `<filename, url>`

#### Parameters

*   `filterExt` **[String][25]** File extension to retrieve in the list
*   `keepExtension` **[Boolean][24]** Keep or remove the file extension
    from the keys (optional, default `false`)

Returns **[Object][22]** Map of `<filename, url>`

### findInTree

Return a node from the tree matching the given path.

#### Parameters

*   `pathOrUrl` **[String][25]** Path of the node to be retrieved, relative to
    `options.dirname` or URL of the node.

Returns **[Object][22]**&#x20;

### readFile

Read a file

#### Parameters

*   `pathname` **[String][25]** Pathname, relative to `options.dirname`.

Returns **[Promise][26]<[Blob][27]>**&#x20;

### writeFile

Write a file

#### Parameters

*   `pathname` **[String][25]** Pathname, relative to `options.dirname`.
*   `data` **([String][25] | File | [Blob][27])** Content of the file. (optional, default `''`)

Returns **[Promise][26]**&#x20;

### mkdir

Create a directory

#### Parameters

*   `pathname` **[String][25]** Path of the directory, relative to `options.dirname`.

Returns **[Promise][26]**&#x20;

### rename

Rename a file or directory

#### Parameters

*   `oldPath` **[String][25]** Current pathname, relative to `options.dirname`.
*   `newPath` **[String][25]** New pathname, relative to `options.dirname`.

Returns **[Promise][26]**&#x20;

### rm

Delete a file or directory

#### Parameters

*   `pathname` **[String][25]** Pathname, relative to `options.dirname`.

Returns **[Promise][26]**&#x20;

## ServerPluginFilesystem

**Extends ServerPlugin**

Server-side representation of the soundworks' filesystem plugin.

The constructor should never be called manually. The plugin will be
instantiated when registered in the `pluginManager`

Available options:

*   `dirname` {String} - directory to watch into
*   `publicPath` {String} - (optional) optional public path for the assets.
    If set, a route will be added to the router to serve the assets and an
    `url` entry will be added to each node of the tree.
*   `depth` {String} - (optional) Maximum depth to watch in the file structure.

If no option is given, for example before a user selects a project, the plugin
will stay idle until `switch` is called.

### Examples

```javascript
server.pluginManager.register('filesystem', filesystemPlugin, {
  dirname: 'my-dir',
  publicPath: 'assets'
});
```

### switch

Switch the filesystem to a new directory, e.g. to change project while
keeping the same plugin and related logic at hand.

#### Parameters

*   `options` **[Object][22]**&#x20;

    *   `options.dirname` **[String][25]** directory to watch, plugin is idle
        if null (optional, default `null`)
    *   `options.publicPath` **[String][25]** optional public path for the
        assets. If set, a route will be added to the router to serve the assets and
        an `url` entry will be added to each node of the tree. (optional, default `null`)

### getTree

Return the current filesystem tree.

Returns **[Object][22]**&#x20;

### onUpdate

Register a callback to execute when a file is created, modified or deleted
on the underlying directory. The callback will receive the updated `tree`
and the list of `events` describing the modifications made on the tree.

#### Parameters

*   `callback` **[Function][23]** Callback function to execute
*   `executeListener` **[boolean][24]** If true, execute the given
    callback immediately. (optional, default `false`)

Returns **[Function][23]** Function that unregister the listener when executed.

### findInTree

Return a node from the tree matching the given path.

#### Parameters

*   `pathname` **[String][25]** Pathname, relative to `options.dirname`.

Returns **[Object][22]**&#x20;

### readFile

Read a file.

#### Parameters

*   `pathname` **[String][25]** Pathname, relative to `options.dirname`.

Returns **[Promise][26]<[Blob][27]>**&#x20;

### writeFile

Write a file

#### Parameters

*   `pathname` **[String][25]** Pathname, relative to `options.dirname`.
*   `data` **([String][25] | [Blob][27])** Content of the file.

Returns **[Promise][26]**&#x20;

### mkdir

Create a directory

#### Parameters

*   `pathname` **[String][25]** Path of the directory, relative to `options.dirname`.

Returns **[Promise][26]**&#x20;

### rename

Rename a file or directory

#### Parameters

*   `oldPath` **[String][25]** Current pathname, relative to `options.dirname`.
*   `newPath` **[String][25]** New pathname, relative to `options.dirname`.

Returns **[Promise][26]**&#x20;

### rm

Delete a file or directory

#### Parameters

*   `pathname` **[String][25]** Pathname, relative to `options.dirname`.

Returns **[Promise][26]**&#x20;

[1]: #clientpluginfilesystem

[2]: #gettree

[3]: #onupdate

[4]: #gettreeasurlmap

[5]: #findintree

[6]: #readfile

[7]: #writefile

[8]: #mkdir

[9]: #rename

[10]: #rm

[11]: #serverpluginfilesystem

[12]: #examples

[13]: #switch

[14]: #gettree-1

[15]: #onupdate-1

[16]: #findintree-1

[17]: #readfile-1

[18]: #writefile-1

[19]: #mkdir-1

[20]: #rename-1

[21]: #rm-1

[22]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[23]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[24]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean

[25]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String

[26]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise

[27]: https://developer.mozilla.org/docs/Web/API/Blob

<!-- apistop -->

## Credits

[https://soundworks.dev/credits.html](https://soundworks.dev/credits.html)

## License

[BSD-3-Clause](./LICENSE)
