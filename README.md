# soundworks | plugin filesystem

[![npm version](https://badge.fury.io/js/@soundworks%2Fplugin-filesystem.svg)](https://badge.fury.io/js/@soundworks%2Fplugin-filesystem)

[`soundworks`](https://soundworks.dev) plugin to watch directories and update their contents from any node.

## Table of Contents

<!-- toc -->

- [Installation](#installation)
- [Usage](#usage)
  * [Server](#server)
  * [Client](#client)
- [Notes](#notes)
  * [Reading files](#reading-files)
  * [Security](#security)
- [API](#api)
  * [Classes](#classes)
  * [PluginFilesystemClient](#pluginfilesystemclient)
  * [PluginFilesystemServer](#pluginfilesystemserver)
- [Credits](#credits)
- [License](#license)

<!-- tocstop -->

## Installation

```sh
npm install @soundworks/plugin-filesystem --save
```

## Usage

### Server

```js
// index.js
import { Server } from '@soundworks/core/server.js';
import pluginFilesystem from '@soundworks/plugin-filesystem/server.js';

const server = new Server();
server.pluginManager.register('filesystem', pluginFilesystem, {
  // path to the watched directory, can be relative to process.cwd()
  // or absolute, in all cases file paths in the tree will be normalized
  // to be relative to `process.cwd()`
  dirname: 'path/to/directory',
  // if defined, add an `url` to each tree node, that defines the
  // route at which the files are publicly accessible.
  publicPath: '',
});

await server.start();

const filesystem = await server.pluginManager.get('filesystem');
await filesystem.writeFile('my-file.txt', 'Hello Server');
```

### Client

#### Registering the plugin

```js
// index.js
import { Client } from '@soundworks/core/client.js';
import pluginFilesystem from '@soundworks/plugin-filesystem/client.js';

const client = new Client();
client.pluginManager.register('filesystem', pluginFilesystem, {});

await client.start();

const filesystem = await client.pluginManager.get('filesystem');
await filesystem.writeFile('my-file.txt', 'Hello Client');
```

## Notes

### Reading files

For now, the filesystem plugin does not provide any way to read files due to the impossibility to have consistent file representation between node and the browser, and to the large type of files that would require different handling or processing (e.g. image, sound, text).

According to your specific needs you can rely on other plugins (e.g. audio-buffer-loader) or on the state manager (e.g. for text files) to read and share the files.

### Security

Being able to write and delete files from any connected client poses evident security questions, moreover if your application aims at running online. To prevent such issues, all sensible operations (i.e. other than listing the files) of the  plugin are blocked if the `env.type` config option passed to the soundworks server is set to `production`. 

In such case, only trusted clients that authentified by a login and password will be able to perform these operations.

See the `config/env-**.js` files to configure your application (@todo - tutorial).

## API

<!-- api -->
<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [PluginFilesystemClient][1]
    *   [Parameters][2]
    *   [getTree][3]
    *   [onUpdate][4]
    *   [getTreeAsUrlMap][5]
    *   [findInTree][6]
    *   [writeFile][7]
    *   [mkdir][8]
    *   [rename][9]
    *   [rm][10]
*   [PluginFilesystemServer][11]
    *   [Parameters][12]
    *   [switch][13]
    *   [getTree][14]
    *   [onUpdate][15]
    *   [findInTree][16]
    *   [writeFile][17]
    *   [mkdir][18]
    *   [rename][19]
    *   [rm][20]

## PluginFilesystemClient

**Extends Plugin**

Client-side representation of the soundworks' filesystem plugin.

### Parameters

*   `client` &#x20;
*   `id` &#x20;
*   `options` &#x20;

### getTree

Return the current filesystem tree.

Returns **[Object][21]**&#x20;

### onUpdate

Register a callback to execute when a file is created, modified or deleted
on the underlying directory. The callback will receive the updated `tree`
and the list of `events` describing the modifications made on the tree.

#### Parameters

*   `callback` **[Function][22]** Callback function to execute
*   `executeListener` **[boolean][23]** If true, execute the given
    callback immediately. (optional, default `false`)

Returns **[Function][22]** Function that unregister the listener when executed.

### getTreeAsUrlMap

Return the tree as flat map of `<filename, url>`

#### Parameters

*   `filterExt` **[String][24]** File extension to retrieve in the list
*   `keepExtension` **[Boolean][23]** Keep or remove the file extension
    from the keys (optional, default `false`)

Returns **[Object][21]** Map of `<filename, url>`

### findInTree

Return a node from the tree matching the given path.

#### Parameters

*   `pathOrUrl` &#x20;
*   `tree`   (optional, default `null`)
*   `path` **[String][24]** Path of the node to be retrieved.

Returns **[Object][21]**&#x20;

### writeFile

Write a file

#### Parameters

*   `pathname` **[String][24]** Pathname.
*   `data` **([String][24] | [Blob][25])** Content of the file.

Returns **[Promise][26]**&#x20;

### mkdir

Create a directory

#### Parameters

*   `pathname` **[String][24]** Path of the directory.

Returns **[Promise][26]**&#x20;

### rename

Rename a file or directory

#### Parameters

*   `oldPath` **[String][24]** Current pathname.
*   `newPath` **[String][24]** New pathname.

Returns **[Promise][26]**&#x20;

### rm

Delete a file or directory

#### Parameters

*   `pathname` **[String][24]** Pathname.

Returns **[Promise][26]**&#x20;

## PluginFilesystemServer

**Extends Plugin**

Server-side representation of the soundworks' filesystem plugin.

### Parameters

*   `server` &#x20;
*   `id` &#x20;
*   `options`   (optional, default `{}`)

### switch

Switch the filesystem to a new directory, e.g. to change project while
keeping the same plugin and related logic at hand.

#### Parameters

*   `options` **[Object][21]**&#x20;

    *   `options.dirname` **[String][24]** directory to watch, plugin is idle
        if null (optional, default `null`)
    *   `options.publicPath` **[String][24]** optionnal public path for the
        assets. If set, a route will be added to the router to serve the assets and
        an `url` entry will be added to each node of the tree. (optional, default `null`)

### getTree

Return the current filesystem tree.

Returns **[Object][21]**&#x20;

### onUpdate

Register a callback to execute when a file is created, modified or deleted
on the underlying directory. The callback will receive the updated `tree`
and the list of `events` describing the modifications made on the tree.

#### Parameters

*   `callback` **[Function][22]** Callback function to execute
*   `executeListener` **[boolean][23]** If true, execute the given
    callback immediately. (optional, default `false`)

Returns **[Function][22]** Function that unregister the listener when executed.

### findInTree

Return a node from the tree matching the given path.

#### Parameters

*   `path` **[String][24]** path of the node to be retrieved
*   `tree`   (optional, default `null`)

Returns **[Object][21]**&#x20;

### writeFile

Write a file

#### Parameters

*   `pathname` **[String][24]** Pathname.
*   `data` **([String][24] | [Blob][25])** Content of the file.

Returns **[Promise][26]**&#x20;

### mkdir

Create a directory

#### Parameters

*   `pathname` **[String][24]** Path of the directory.

Returns **[Promise][26]**&#x20;

### rename

Rename a file or directory

#### Parameters

*   `oldPath` **[String][24]** Current pathname.
*   `newPath` **[String][24]** New pathname.

Returns **[Promise][26]**&#x20;

### rm

Delete a file or directory

#### Parameters

*   `pathname` **[String][24]** Pathname.

Returns **[Promise][26]**&#x20;

[1]: #pluginfilesystemclient

[2]: #parameters

[3]: #gettree

[4]: #onupdate

[5]: #gettreeasurlmap

[6]: #findintree

[7]: #writefile

[8]: #mkdir

[9]: #rename

[10]: #rm

[11]: #pluginfilesystemserver

[12]: #parameters-8

[13]: #switch

[14]: #gettree-1

[15]: #onupdate-1

[16]: #findintree-1

[17]: #writefile-1

[18]: #mkdir-1

[19]: #rename-1

[20]: #rm-1

[21]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[22]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[23]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean

[24]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String

[25]: https://developer.mozilla.org/docs/Web/API/Blob

[26]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise

<!-- apistop -->

## Credits

[https://soundworks.dev/credits.html](https://soundworks.dev/credits.html)

## License

[BSD-3-Clause](./LICENSE)
